name: Optimize images

on:
  push:
    paths:
      - "imgs/**"
      - ".github/workflows/image-optimizer.yml"
  pull_request:
    paths:
      - "imgs/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  optimize:
    runs-on: ubuntu-latest

    env:
      SOURCE_DIR: "imgs"
      TARGET_DIR: "images"
      SIZES: "480 960 1440 1920"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm i sharp@^0.33.0 globby@^14.0.1

      - name: Copy originals and generate variants
        id: optimize
        run: |
          node --input-type=module - <<'NODE'
          import { globby } from 'globby';
          import sharp from 'sharp';
          import fs from 'node:fs/promises';
          import path from 'node:path';

          const SOURCE_DIR = (process.env.SOURCE_DIR || 'imgs').replace(/\/+$/,'');
          const TARGET_DIR = (process.env.TARGET_DIR || 'images').replace(/\/+$/,'');
          const SIZES = (process.env.SIZES || '480 960 1440 1920')
            .split(/\s+/)
            .map(s => parseInt(s, 10))
            .filter(Boolean);

          let changed = 0;

          const exists = async p => !!(await fs.stat(p).catch(() => null));

          const ensureTargetDir = async (src) => {
            const rel = path.relative(SOURCE_DIR, src);
            const relDir = path.dirname(rel);
            const targetDir = path.join(TARGET_DIR, relDir === '.' ? '' : relDir);
            await fs.mkdir(targetDir, { recursive: true });
            return { rel, targetDir };
          };

          const copyOriginal = async (src) => {
            const { targetDir } = await ensureTargetDir(src);
            const fileName = path.basename(src);
            const out = path.join(targetDir, fileName);

            if (await exists(out)) return;

            await fs.copyFile(src, out);
            changed = 1;
          };

          const genVariant = async (src, w, format) => {
            const { targetDir } = await ensureTargetDir(src);
            const name = path.basename(src, path.extname(src));
            const out = path.join(targetDir, `${name}-${w}.${format}`);

            if (await exists(out)) return;

            const base = sharp(src, { failOn: 'none' }).resize({
              width: w,
              withoutEnlargement: true,
            });

            if (format === 'webp') {
              await base.webp({ quality: 100, effort: 4 }).toFile(out);
            } else if (format === 'avif') {
              await base.avif({ quality: 100, effort: 4 }).toFile(out);
            }
            changed = 1;
          };

          const patterns = [
            `${SOURCE_DIR}/**/*.{jpg,jpeg,JPG,JPEG}`,
          ];

          const files = await globby(patterns, { dot: false, onlyFiles: true });
          if (!files.length) {
            console.log('No images found in', SOURCE_DIR);
          }

          for (const src of files) {
            console.log('Processing:', src);
            try {
              await copyOriginal(src);

              for (const w of SIZES) {
                await Promise.all([
                  genVariant(src, w, 'webp'),
                  genVariant(src, w, 'avif'),
                ]);
              }
            } catch (err) {
              console.error('Error on', src, err);
            }
          }

          console.log('changed=' + changed);
          await fs.appendFile(process.env.GITHUB_OUTPUT, `changed=${changed}\n`);
          NODE

      - name: Commit optimized images
        if: steps.optimize.outputs.changed == '1'
        uses: EndBug/add-and-commit@v9
        with:
          add: |
            imgs/**
            images/**
          message: "chore(images): copy originals & generate responsive variants [skip ci]"
          default_author: github_actions
